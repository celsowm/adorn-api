// src/cli/generate-routes.ts
import { Project } from "ts-morph";
import * as fs from "fs";
const PROJECT_ROOT = "./tsconfig.json";
const OUTPUT_FILE = "./src/routes.ts"; // We generate this file!
const project = new Project({ tsConfigFilePath: PROJECT_ROOT });
let routeCode = `/* tslint:disable */
/* eslint-disable */
// WARNING: This file was auto-generated by adorn-api. Do not edit.
import { Express, Request, Response } from 'express';
`;
// Helper to keep track of imports we need to add to the generated file
const imports = new Set();
function processController(classDec) {
    const className = classDec.getName();
    if (!className)
        return "";
    // Track import (assuming controllers are in ./controllers/)
    const sourceFile = classDec.getSourceFile();
    const baseName = sourceFile.getBaseName().replace('.ts', '.js');
    const relativePath = sourceFile.getDirectoryPath().replace(process.cwd() + "/src", ".");
    imports.add(`import { ${className} } from '${relativePath}/${baseName}';`);
    const controllerDec = classDec.getDecorators().find(d => d.getName() === "Controller");
    if (!controllerDec)
        return "";
    const basePath = controllerDec.getArguments()[0]?.getText().replace(/['"]/g, "") || "/";
    let methodBlocks = "";
    classDec.getMethods().forEach(method => {
        const getDec = method.getDecorator("Get");
        const postDec = method.getDecorator("Post");
        const putDec = method.getDecorator("Put");
        const deleteDec = method.getDecorator("Delete");
        const decorator = getDec || postDec || putDec || deleteDec;
        if (!decorator)
            return;
        const httpMethod = getDec ? "get" : postDec ? "post" : putDec ? "put" : "delete";
        const pathArg = decorator.getArguments()[0]?.getText().replace(/['"]/g, "") || "/";
        const fullPath = `/${basePath}${pathArg}`.replace("//", "/").replace(/{/g, ":").replace(/}/g, ""); // Convert {id} to :id for Express
        const methodName = method.getName();
        const params = method.getParameters();
        // Authentication check
        const authDec = method.getDecorator("Authorized");
        const controllerAuthDec = classDec.getDecorator("Authorized");
        const hasAuth = !!authDec || !!controllerAuthDec;
        const middlewareArgs = hasAuth ? "authenticationMiddleware, " : "";
        // Logic to instantiate the DTO
        let paramInstantiation = "";
        if (params.length > 0) {
            const paramName = params[0].getName();
            const paramType = params[0].getType().getSymbol()?.getName();
            // We assume the DTO is a class we can instantiate, or a shape we construct
            // Here we map request parts to the DTO
            paramInstantiation = `
        const input: any = {};
        // Map Query
        Object.assign(input, req.query);
        // Map Params
        Object.assign(input, req.params);
        // Map Body
        Object.assign(input, req.body);
        
        // In a real app, you would run 'zod' or 'class-validator' here on 'input'
      `;
        }
        methodBlocks += `
    app.${httpMethod}('${fullPath}', ${middlewareArgs}async (req: Request, res: Response) => {
        const controller = new ${className}();
        try {
            ${paramInstantiation}
            const response = await controller.${methodName}(${params.length > 0 ? 'input' : ''});
            res.status(200).json(response);
        } catch (err: any) {
            console.error(err);
            res.status(500).send(err.message);
        }
    });
    `;
    });
    return methodBlocks;
}
const sourceFiles = project.getSourceFiles("src/controllers/**/*.ts");
let allRoutes = "";
sourceFiles.forEach(file => {
    file.getClasses().forEach(c => {
        allRoutes += processController(c);
    });
});
// Add authentication middleware import if needed
if (allRoutes.includes('authenticationMiddleware')) {
    routeCode += `import { authenticationMiddleware } from './middleware/auth.middleware.js';\n`;
}
// Prepend imports
routeCode += Array.from(imports).join('\n');
routeCode += `

export function RegisterRoutes(app: Express) {
    ${allRoutes}
}
`;
fs.writeFileSync(OUTPUT_FILE, routeCode);
console.log(`âœ… Generated Routes at ${OUTPUT_FILE}`);
